# Claude Code ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹éš›ã«ã€Claude CodeãŒå®ˆã‚‹ã¹ãè¦ç´„ã‚’å®šç¾©ã—ã¾ã™ã€‚

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

### ãƒ•ã‚¡ã‚¤ãƒ«å‘½å
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `PascalCase.tsx` (ä¾‹: `ChatInterface.tsx`)
- ãƒ•ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«: `camelCase.ts` (ä¾‹: `useChat.ts`)
- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«: `camelCase.ts` (ä¾‹: `validation.ts`)
- å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«: `camelCase.ts` (ä¾‹: `chat.ts`)

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```typescript
/**
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯[æ©Ÿèƒ½å]ã®[ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ/ãƒ•ãƒƒã‚¯/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£]ã§ã™ã€‚
 * 
 * ä¸»ãªæ©Ÿèƒ½ï¼š
 * - [æ©Ÿèƒ½1]
 * - [æ©Ÿèƒ½2]
 * - [æ©Ÿèƒ½3]
 * 
 * ä½¿ç”¨ä¾‹ï¼š
 * ```typescript
 * import { ComponentName } from './ComponentName';
 * ```
 */
```

## 2. TypeScriptå‹å®šç¾©ã®å³æ ¼åŒ–

### åŸºæœ¬åŸå‰‡
- `any`å‹ã®ä½¿ç”¨ã‚’ç¦æ­¢
- ã™ã¹ã¦ã®é–¢æ•°ã«æˆ»ã‚Šå€¤ã®å‹ã‚’æ˜ç¤º
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯`PascalCase`ã§å‘½å
- å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯`PascalCase`ã§å‘½å

### å‹å®šç¾©ä¾‹
```typescript
interface ChatMessage {
  id: string;
  content: string;
  timestamp: Date;
  sender: 'user' | 'ai';
  attachments?: {
    type: 'image' | 'audio';
    url: string;
  }[];
}

type MessageStatus = 'sending' | 'sent' | 'error';
```

## 3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### Propså‹å®šç¾©
```typescript
interface ComponentProps {
  // å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  requiredProp: string;
  
  // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  optionalProp?: number;
  
  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
  onAction?: (data: ActionData) => void;
  
  // ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
  className?: string;
  style?: React.CSSProperties;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
export default function Component({
  requiredProp,
  optionalProp = 0,
  onAction,
  className = "",
  style
}: ComponentProps) {
  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
}
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹é€ 
1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡
2. å‹å®šç¾©
3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©
4. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
import { z } from 'zod';

const UserSchema = z.object({
  email: z.string().email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
  password: z.string().min(8, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'),
  name: z.string().min(1, 'åå‰ã¯å¿…é ˆã§ã™')
});

const validateUser = (data: unknown) => {
  try {
    return UserSchema.parse(data);
  } catch (error) {
    if (error instanceof z.ZodError) {
      throw new Error(`ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.errors.map(e => e.message).join(', ')}`);
    }
    throw error;
  }
};
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
const handleAsyncOperation = async () => {
  try {
    const result = await someAsyncOperation();
    return result;
  } catch (error) {
    console.error('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    throw new Error('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
};
```

## 5. Supabaseã¨ã®çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

### å‹å®‰å…¨ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
```typescript
interface Database {
  public: {
    Tables: {
      [table_name]: {
        Row: {
          // ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®å‹å®šç¾©
        };
        Insert: {
          // æŒ¿å…¥æ™‚ã®å‹å®šç¾©
        };
        Update: {
          // æ›´æ–°æ™‚ã®å‹å®šç¾©
        };
      };
    };
  };
}

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);
```

### ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
const fetchData = async () => {
  const { data, error } = await supabase
    .from('table_name')
    .select('*')
    .eq('column', value);

  if (error) {
    throw new Error(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
  }

  return data;
};
```

## 6. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®è¨­è¨ˆ

### ãƒ•ãƒƒã‚¯ã®åŸºæœ¬æ§‹é€ 
```typescript
interface UseHookReturn {
  data: DataType;
  isLoading: boolean;
  error: string | null;
  actions: {
    action1: () => Promise<void>;
    action2: () => void;
  };
}

export function useCustomHook(param: string): UseHookReturn {
  const [data, setData] = useState<DataType>(initialValue);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // å‰¯ä½œç”¨ã®å‡¦ç†
  useEffect(() => {
    // å‰¯ä½œç”¨ã®å®Ÿè£…
  }, [param]);

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°
  const action1 = async () => {
    // å®Ÿè£…
  };

  const action2 = () => {
    // å®Ÿè£…
  };

  return {
    data,
    isLoading,
    error,
    actions: {
      action1,
      action2
    }
  };
}
```

## 7. ç’°å¢ƒå¤‰æ•°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ç’°å¢ƒå¤‰æ•°ã®å‹å®‰å…¨ãªä½¿ç”¨
```typescript
const requiredEnvVars = {
  SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  DIFY_API_KEY: process.env.DIFY_API_KEY,
} as const;

// ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
Object.entries(requiredEnvVars).forEach(([key, value]) => {
  if (!value) {
    throw new Error(`å¿…è¦ãªç’°å¢ƒå¤‰æ•° ${key} ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
  }
});
```

### APIã‚­ãƒ¼ã®å®‰å…¨ãªä½¿ç”¨
```typescript
// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨
const apiKey = process.env.SECRET_API_KEY;

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ä½¿ç”¨å¯èƒ½
const publicKey = process.env.NEXT_PUBLIC_API_KEY;
```

## 8. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã¨Tailwind CSS

### ã‚¯ãƒ©ã‚¹åã®ç®¡ç†
```typescript
import { clsx } from 'clsx';

const buttonClasses = clsx(
  // åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
  "px-4 py-2 rounded-md font-medium transition-colors",
  
  // çŠ¶æ…‹ã«ã‚ˆã‚‹ã‚¹ã‚¿ã‚¤ãƒ«
  "bg-blue-500 text-white hover:bg-blue-600",
  "disabled:bg-gray-300 disabled:cursor-not-allowed",
  
  // ã‚µã‚¤ã‚ºãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
  "text-sm sm:text-base",
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
  "w-full sm:w-auto"
);
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
```typescript
const cardVariants = {
  default: "bg-white border border-gray-200",
  elevated: "bg-white shadow-lg border-0",
  outlined: "bg-transparent border-2 border-gray-300"
} as const;

type CardVariant = keyof typeof cardVariants;
```

## 9. ãƒ†ã‚¹ãƒˆå¯èƒ½ãªã‚³ãƒ¼ãƒ‰è¨­è¨ˆ

### ä¾å­˜æ€§æ³¨å…¥
```typescript
interface ServiceInterface {
  fetchData(): Promise<Data[]>;
  saveData(data: Data): Promise<void>;
}

export function useDataWithService(service: ServiceInterface) {
  // ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ³¨å…¥å¯èƒ½
}
```

### ç´”ç²‹é–¢æ•°ã®è¨­è¨ˆ
```typescript
// å‰¯ä½œç”¨ã®ãªã„ç´”ç²‹é–¢æ•°
export const formatMessage = (message: string, timestamp: Date): FormattedMessage => {
  return {
    content: message.trim(),
    formattedTime: timestamp.toLocaleString('ja-JP'),
    wordCount: message.split(' ').length
  };
};
```

## 10. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

### åŸºæœ¬çš„ãªã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
```typescript
// ãƒœã‚¿ãƒ³è¦ç´ 
<button
  onClick={handleClick}
  aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
  aria-describedby="message-input-description"
  disabled={isLoading}
  className="px-4 py-2 bg-blue-500 text-white rounded"
>
  {isLoading ? 'é€ä¿¡ä¸­...' : 'é€ä¿¡'}
</button>

// ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ 
<form onSubmit={handleSubmit} aria-labelledby="form-title">
  <h2 id="form-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›</h2>
  <label htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
  <input
    id="email"
    type="email"
    aria-required="true"
    aria-describedby="email-error"
  />
  <div id="email-error" role="alert" aria-live="polite">
    {emailError}
  </div>
</form>
```

### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
const handleKeyDown = (event: React.KeyboardEvent) => {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    handleSubmit();
  }
};
```

## 11. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### React.memoã®ä½¿ç”¨
```typescript
const ExpensiveComponent = React.memo(({ data }: Props) => {
  // é‡ã„å‡¦ç†ã‚’å«ã‚€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  return <div>{/* ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å†…å®¹ */}</div>;
});
```

### useMemoã¨useCallback
```typescript
const memoizedValue = useMemo(() => {
  return expensiveCalculation(data);
}, [data]);

const memoizedCallback = useCallback(() => {
  handleAction(data);
}, [data, handleAction]);
```

## 12. ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### JSDocã‚³ãƒ¡ãƒ³ãƒˆ
```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
 * 
 * @param content - é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹
 * @param attachments - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®é…åˆ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æƒ…å ±
 * 
 * @example
 * ```typescript
 * const message = await sendMessage("ã“ã‚“ã«ã¡ã¯", [file]);
 * console.log(message.id);
 * ```
 */
export async function sendMessage(
  content: string,
  attachments?: File[]
): Promise<ChatMessage> {
  // å®Ÿè£…
}
```

## 13. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¨ãƒ‡ãƒãƒƒã‚°

### æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ­ã‚°
```typescript
const logger = {
  info: (message: string, data?: any) => {
    console.log(`[INFO] ${message}`, data);
  },
  error: (message: string, error?: Error) => {
    console.error(`[ERROR] ${message}`, error);
  },
  warn: (message: string, data?: any) => {
    console.warn(`[WARN] ${message}`, data);
  }
};
```

## 14. å›½éš›åŒ–å¯¾å¿œ

### å¤šè¨€èªå¯¾å¿œã®æº–å‚™
```typescript
const messages = {
  ja: {
    send: 'é€ä¿¡',
    loading: 'èª­ã¿è¾¼ã¿ä¸­...',
    error: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
  },
  en: {
    send: 'Send',
    loading: 'Loading...',
    error: 'An error occurred'
  }
} as const;

type Language = keyof typeof messages;
```

## 15. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### XSSå¯¾ç­–
```typescript
// å±é™ºãªHTMLã®æŒ¿å…¥ã‚’é¿ã‘ã‚‹
const sanitizeHtml = (html: string): string => {
  // DOMPurifyãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
  return DOMPurify.sanitize(html);
};

// Reactã§ã¯dangerouslySetInnerHTMLã®ä½¿ç”¨ã‚’æœ€å°é™ã«
<div dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />
```

### CSRFå¯¾ç­–
```typescript
// APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨
const apiCall = async (data: any) => {
  const response = await fetch('/api/endpoint', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': getCsrfToken()
    },
    body: JSON.stringify(data)
  });
};
```

## 16. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ğŸ¯ è¨­è¨ˆæ–¹é‡
- **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè»¸**: å„è¡Œã¯ `hospital_id` ã§ã‚¹ã‚³ãƒ¼ãƒ—
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼é€£å‹•**: `auth.uid()` ã‚’ä¸­å¿ƒã«æ‰€å±ãƒ»æ¨©é™ã‚’åˆ¤å®š
- **ã‚»ãƒ¼ãƒ•ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: RLSã¯ `enable + force`ã€ãƒãƒªã‚·ãƒ¼ãŒç„¡ã„æ“ä½œã¯æ‹’å¦
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å…ˆç½®ã**: RLSã® `using/exists` ã§å‚ç…§ã™ã‚‹åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

### ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
scripts/
â”œâ”€â”€ 01_helpers.sql      # èªå¯ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°/ãƒ“ãƒ¥ãƒ¼/ãƒˆãƒªã‚¬
â”œâ”€â”€ 02_rls.sql          # å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSï¼ˆSELECT/INSERT/UPDATE/DELETEï¼‰
â”œâ”€â”€ 03_grants.sql       # æ¨©é™ï¼ˆREVOKE/GRANTã€RLS FORCEï¼‰
â”œâ”€â”€ 04_indexes.sql      # ãƒãƒªã‚·ãƒ¼ã§ä½¿ã†åˆ—ã¸ã®ç´¢å¼•
â””â”€â”€ 99_tests.sql        # æƒ³å®šæˆåŠŸ/å¤±æ•—ãƒ‘ã‚¹ã®ç¢ºèªã‚¯ã‚¨ãƒª
```

### ğŸ§© ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆ01_helpers.sqlï¼‰
```sql
-- è‡ªåˆ†ã®æœ‰åŠ¹ãªç—…é™¢æ‰€å±
create or replace view v_current_memberships as
select m.user_id, m.hospital_id
from public.user_hospital_memberships m
where m.user_id = auth.uid()
  and m.is_enabled
  and now() >= m.valid_from
  and (m.valid_to is null or now() < m.valid_to);

-- ç—…é™¢ãƒ¡ãƒ³ãƒãƒ¼åˆ¤å®š
create or replace function fn_is_member(h uuid) returns boolean
language sql stable as $$
  select exists(select 1 from v_current_memberships where hospital_id = h);
$$;

-- ãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼ˆglobal/hospitalï¼‰
create or replace function fn_has_role(role_code text, h uuid default null)
returns boolean language sql stable as $$
  with my_roles as (
    select r.code, ra.scope, ra.hospital_id
    from public.role_assignments ra
    join public.roles r on r.id = ra.role_id
    where ra.user_id = auth.uid()
  )
  select exists(
    select 1 from my_roles
     where code = role_code
       and (scope = 'global' or (scope = 'hospital' and hospital_id = coalesce(h, hospital_id)))
  );
$$;

-- ç—…é™¢ç®¡ç†è€…ã®ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ³ãƒ‰
create or replace function fn_is_admin(h uuid) returns boolean
language sql stable as $$
  select fn_has_role('admin', h) or fn_has_role('platform_admin', null);
$$;

-- ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ åˆ¤å®š
create or replace function fn_is_session_member(sid uuid) returns boolean
language sql stable as $$
  select exists(select 1 from public.chat_session_members m
                 where m.session_id = sid and m.user_id = auth.uid())
      or exists(select 1 from public.chat_sessions s
                 where s.id = sid and s.user_id = auth.uid());
$$;
```

### ğŸ›¡ï¸ RLSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ02_rls.sqlï¼‰
```sql
-- ç—…é™¢ç›´ä¸‹ãƒ†ãƒ¼ãƒ–ãƒ«
alter table hospitals enable row level security;
alter table hospitals force row level security;

drop policy if exists sel_hospitals on hospitals;
create policy sel_hospitals on hospitals
for select using (exists (select 1 from v_current_memberships m where m.hospital_id = id));

drop policy if exists wrt_hospitals on hospitals;
create policy wrt_hospitals on hospitals
for all using (fn_is_admin(id)) with check (fn_is_admin(id));

-- hospital_id ã‚’æŒã¤ãƒã‚¹ã‚¿
alter table positions enable row level security;
alter table positions force row level security;

drop policy if exists sel_positions on positions;
create policy sel_positions on positions
for select using (fn_is_member(hospital_id));

drop policy if exists wrt_positions on positions;
create policy wrt_positions on positions
for all using (fn_is_admin(hospital_id)) with check (fn_is_admin(hospital_id));

-- ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³
alter table chat_sessions enable row level security;
alter table chat_sessions force row level security;

drop policy if exists sel_chat_sessions on chat_sessions;
create policy sel_chat_sessions on chat_sessions
for select using (
  fn_is_member(hospital_id)
  and (user_id = auth.uid() or fn_is_session_member(id))
);

drop policy if exists ins_chat_sessions on chat_sessions;
create policy ins_chat_sessions on chat_sessions
for insert with check (
  fn_is_member(hospital_id)
  and (app_id is null or fn_app_enabled_for_hospital(app_id, hospital_id))
);
```

### ğŸ æ¨©é™è¨­å®šï¼ˆ03_grants.sqlï¼‰
```sql
-- åŸºæœ¬æ¨©é™ã®å–ã‚Šæ¶ˆã—
revoke all on all tables in schema public from public;
grant usage on schema public to postgres, anon, authenticated, service_role;

-- RLSãŒå®ˆã‚‹å‰æã§ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ«ã¸ä»˜ä¸
grant select, insert, update, delete on all tables in schema public to authenticated;

-- ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ RLS ã‚’å¼·åˆ¶
do $$ declare r record; begin
  for r in select table_name from information_schema.tables
           where table_schema='public' and table_type='BASE TABLE'
  loop
    execute format('alter table public.%I enable row level security;', r.table_name);
    execute format('alter table public.%I force row level security;', r.table_name);
  end loop;
end $$;
```

### âš¡ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ04_indexes.sqlï¼‰
```sql
-- ç—…é™¢ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆå¿…é ˆï¼‰
create index if not exists idx_hospital_id on table_name(hospital_id);

-- ãƒãƒ£ãƒƒãƒˆé–¢é€£
create index if not exists idx_chat_messages_session_created 
  on chat_messages(session_id, created_at);
create index if not exists idx_chat_session_members_session_user 
  on chat_session_members(session_id, user_id);

-- æ‰€å±ãƒ»æ¨©é™
create index if not exists idx_user_hospital_memberships_user_hospital 
  on user_hospital_memberships(user_id, hospital_id, is_enabled, valid_from, valid_to);

-- å½¹å‰²
create index if not exists idx_role_assignments_user_hospital 
  on role_assignments(user_id, hospital_id);

-- ã‚¢ãƒ—ãƒªæœ‰åŠ¹åŒ–
create index if not exists idx_hospital_apps_hospital_app 
  on hospital_apps(hospital_id, app_id, is_enabled);
```

### ğŸ§ª ãƒ†ã‚¹ãƒˆï¼ˆ99_tests.sqlï¼‰
```sql
-- ãƒ¡ãƒ³ãƒãƒ¼/éãƒ¡ãƒ³ãƒãƒ¼/ç—…é™¢ç®¡ç†è€…/ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†è€…ã®å„ãƒ­ãƒ¼ãƒ«ã§
-- SELECT/INSERT/UPDATE/DELETE ã®æˆåŠŸ/å¤±æ•—ã‚’ç¢ºèª

-- ä¾‹ï¼šç—…é™¢ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ãŒç—…é™¢æƒ…å ±ã‚’é–²è¦§å¯èƒ½
select * from hospitals where id = 'hospital-uuid'; -- expect: ok (ãƒ¡ãƒ³ãƒãƒ¼) / deny (éãƒ¡ãƒ³ãƒãƒ¼)

-- ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ è€…ã®ã¿ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–²è¦§ãƒ»æŠ•ç¨¿å¯èƒ½
select * from chat_messages where session_id = 'session-uuid'; -- expect: ok (å‚åŠ è€…) / deny (éå‚åŠ è€…)

-- ãƒ­ã‚°ã¯ INSERT ã§ãã‚‹ãŒ SELECT åˆ¶é™
insert into audit_logs (action, table_name, record_id) values ('SELECT', 'hospitals', 'uuid'); -- expect: ok
select * from audit_logs; -- expect: deny (ç®¡ç†è€…ä»¥å¤–)
```

### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„
- ã‚¹ã‚­ãƒ¼ãƒã®ç ´å£Šçš„å¤‰æ›´ï¼ˆã‚«ãƒ©ãƒ å‰Šé™¤/å‹å¤‰æ›´ï¼‰
- RLSç„¡åŠ¹åŒ–ã‚„ force ã®å¤–ã—
- SECURITY DEFINER ã®æ¿«ç”¨ï¼ˆå¿…è¦æœ€å°ï¼‰

### âœï¸ ã‚¹ã‚¿ã‚¤ãƒ«
- èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšä»˜ä¸ï¼ˆãªãœã“ã®RLSã‹ï¼‰
- ã™ã¹ã¦å†å®Ÿè¡Œå®‰å…¨ï¼ˆidempotentï¼‰
- è¿·ã£ãŸã‚‰ deny by defaultã€‚é€Ÿã•ã‚ˆã‚Šå®‰å…¨ã€‚å®‰å…¨ãŒé€Ÿã•ã‚’ç”Ÿã‚€ã€‚

### TypeScriptã§ã®DBæ“ä½œ
```typescript
// å‹å®‰å…¨ãªSupabaseã‚¯ã‚¨ãƒª
interface Database {
  public: {
    Tables: {
      chat_sessions: {
        Row: {
          id: string;
          hospital_id: string;
          user_id: string;
          title: string;
          created_at: string;
        };
        Insert: {
          hospital_id: string;
          user_id: string;
          title: string;
        };
        Update: {
          title?: string;
        };
      };
    };
  };
}

// ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
const fetchChatSessions = async (hospitalId: string) => {
  const { data, error } = await supabase
    .from('chat_sessions')
    .select('*')
    .eq('hospital_id', hospitalId);

  if (error) {
    throw new Error(`ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
  }

  return data;
};
```

---

## é©ç”¨æ–¹æ³•

1. æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãéš›ã¯ã€ã“ã®è¦ç´„ã«å¾“ã£ã¦ãã ã•ã„
2. æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹éš›ã‚‚ã€å¯èƒ½ãªé™ã‚Šã“ã®è¦ç´„ã«åˆã‚ã›ã¦ãã ã•ã„
3. è¦ç´„ã«å¾“ã‚ãªã„å ´åˆã¯ã€æ˜ç¢ºãªç†ç”±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã—ã¦ãã ã•ã„
4. å®šæœŸçš„ã«ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§è¦ç´„ã®éµå®ˆçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„

ã“ã®è¦ç´„ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æˆé•·ã«åˆã‚ã›ã¦ç¶™ç¶šçš„ã«æ”¹å–„ã—ã¦ã„ãã¾ã™ã€‚
