import { supabase } from './supabase';
import { createClient } from '@supabase/supabase-js';

// ÂàÜÊûêÁî®„ÅÆ„Çµ„Éº„Éì„Çπ„É≠„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÔºàRLSÂõûÈÅøÔºâ
const analyticsSupabase = typeof window === 'undefined' ? supabase : createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);

export interface AnalyticsSession {
  id?: string;
  user_id?: string;
  user_permission?: string;
  session_id: string;
  start_time?: string;
  end_time?: string;
  duration_seconds?: number;
  page_views?: number;
  device_type?: string;
  user_agent?: string;
  referrer?: string;
  ip_address?: string;
}

export interface AnalyticsEvent {
  session_id: string;
  user_id?: string;
  user_permission?: string;
  event_type: 'page_view' | 'click' | 'chat_message' | 'feature_use' | 'error';
  page_path?: string;
  element_id?: string;
  element_type?: string;
  event_data?: Record<string, unknown>;
}

export interface AnalyticsError {
  session_id: string;
  user_id?: string;
  user_permission?: string;
  error_type: string;
  error_message?: string;
  stack_trace?: string;
  page_path?: string;
  user_agent?: string;
}

class AnalyticsService {
  private currentSessionId: string = '';
  private sessionStartTime: Date = new Date();
  private pageViews: number = 0;

  private initialized = false;

  constructor() {
    if (typeof window !== 'undefined') {
      this.currentSessionId = this.generateSessionId();
      // ÂàùÊúüÂåñ„ÇíÈÅÖÂª∂ÂÆüË°å
      setTimeout(() => this.initializeSession(), 1000);
      this.setupUnloadListener();
    }
  }

  private async ensureInitialized() {
    if (this.initialized || typeof window === 'undefined') return;
    
    try {
      await this.initializeSession();
      this.initialized = true;
    } catch (error) {
      console.warn('Analytics initialization skipped:', error);
    }
  }

  private generateSessionId(): string {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  private getDeviceType(): string {
    if (typeof window === 'undefined') return 'server';
    
    const width = window.innerWidth;
    if (width <= 768) return 'mobile';
    if (width <= 1024) return 'tablet';
    return 'desktop';
  }

  private async initializeSession(): Promise<void> {
    try {
      console.log('üîÑ Starting analytics session initialization...');
      console.log('üîß Supabase client info:', {
        url: process.env.NEXT_PUBLIC_SUPABASE_URL || 'Not set',
        key: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'Set' : 'Not set'
      });
      
      // „Åæ„ÅöÂü∫Êú¨ÁöÑ„Å™Êé•Á∂ö„ÉÜ„Çπ„Éà
      const { data: basicTest, error: basicError } = await supabase
        .from('auth')
        .select('*')
        .limit(1);
      
      console.log('üîå Basic connection test:', { basicTest, basicError });
      
      // SupabaseÊé•Á∂ö„ÉÜ„Çπ„Éà
      const { data: connectionTest, error: connectionError } = await supabase
        .from('information_schema')
        .select('table_name')
        .eq('table_name', 'analytics_sessions')
        .limit(1);
      
      console.log('üìä Connection test result:', { connectionTest, connectionError });
      
      if (connectionError) {
        console.warn('‚ùå Supabase connection failed:', connectionError);
        return;
      }
      
      // „ÉÜ„Éº„Éñ„É´Â≠òÂú®Á¢∫Ë™ç
      const { error: tableError } = await supabase
        .from('analytics_sessions')
        .select('id')
        .limit(1);
      
      if (tableError) {
        console.warn('‚ùå Analytics table not found:', {
          message: tableError.message,
          code: tableError.code,
          details: tableError.details,
          hint: tableError.hint
        });
        console.warn('üîß Please run analytics-setup.sql in Supabase to create the analytics tables');
        return;
      }
      
      console.log('‚úÖ Analytics tables verified');

      console.log('üîÑ Creating session data...');
      const sessionData: AnalyticsSession = {
        session_id: this.currentSessionId,
        start_time: this.sessionStartTime.toISOString(),
        device_type: this.getDeviceType(),
        user_agent: navigator.userAgent,
        referrer: document.referrer || undefined,
        page_views: 0,
      };

      console.log('üîÑ Getting user data...');
      const { data: userData, error: userError } = await supabase.auth.getUser();
      
      if (userError) {
        console.warn('‚ö†Ô∏è User auth error:', userError);
      }
      
      if (userData.user) {
        sessionData.user_id = userData.user.id;
        // „É¶„Éº„Ç∂„Éº„ÅÆpermissionÊÉÖÂ†±„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆÂ†¥ÊâÄ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        const permission = 
          userData.user.user_metadata?.permission ||
          (userData.user as { raw_user_meta_data?: { permission?: string } }).raw_user_meta_data?.permission ||
          'unknown';
        sessionData.user_permission = permission as string;
        
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
        console.log('üë§ User authenticated - ID:', userData.user.id);
        console.log('üîë User permission:', permission);
        console.log('üìù User metadata:', userData.user.user_metadata);
      } else {
        console.log('üë§ User not authenticated, using anonymous session');
      }
      
      console.log('üìã Final session data:', sessionData);

      console.log('üîÑ Inserting session data...');
      const { data: insertResult, error } = await analyticsSupabase
        .from('analytics_sessions')
        .insert([sessionData])
        .select();

      if (error) {
        console.error('‚ùå Failed to initialize analytics session:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code,
          sessionData: sessionData
        });
        
        // ÂÖ∑‰ΩìÁöÑ„Å™„Ç®„É©„ÉºÂàÜÊûê
        if (error.code === 'PGRST116') {
          console.error('üîß Table does not exist. Please run analytics-setup.sql');
        } else if (error.code === '23505') {
          console.error('üîß Duplicate session ID. Retrying with new ID...');
          this.currentSessionId = this.generateSessionId();
          await this.initializeSession(); // „É™„Éà„É©„Ç§
          return;
        } else if (error.message.includes('permission')) {
          console.error('üîß Permission denied. Check RLS policies.');
        }
      } else {
        console.log('‚úÖ Analytics session initialized successfully:', insertResult);
        this.initialized = true;
      }
    } catch (error) {
      console.error('üí• Analytics initialization critical error:', {
        error: error,
        type: typeof error,
        message: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : undefined
      });
    }
  }

  private setupUnloadListener() {
    window.addEventListener('beforeunload', () => {
      this.endSession();
    });
  }

  async trackPageView(pagePath: string) {
    if (typeof window === 'undefined') return;
    
    console.log('üîç Tracking page view:', pagePath);
    await this.ensureInitialized();
    
    if (!this.initialized) {
      console.warn('‚ö†Ô∏è Analytics not initialized, skipping page view tracking');
      return;
    }
    
    this.pageViews++;
    await this.trackEvent({
      session_id: this.currentSessionId,
      event_type: 'page_view',
      page_path: pagePath,
    });

    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Éö„Éº„Ç∏„Éì„É•„ÉºÊï∞„ÇíÊõ¥Êñ∞
    await this.updateSessionPageViews();
  }

  async trackClick(elementId: string, elementType: string, pagePath?: string) {
    if (typeof window === 'undefined') return;
    
    await this.ensureInitialized();
    if (!this.initialized) return;
    
    await this.trackEvent({
      session_id: this.currentSessionId,
      event_type: 'click',
      page_path: pagePath || window.location.pathname,
      element_id: elementId,
      element_type: elementType,
    });
  }

  async trackChatMessage(messageLength: number, isUser: boolean) {
    if (typeof window === 'undefined') return;
    
    await this.ensureInitialized();
    await this.trackEvent({
      session_id: this.currentSessionId,
      event_type: 'chat_message',
      page_path: '/AIchat',
      event_data: {
        message_length: messageLength,
        sender: isUser ? 'user' : 'ai',
        timestamp: new Date().toISOString(),
      },
    });
  }

  async trackFeatureUse(featureName: string, pagePath: string, additionalData?: Record<string, unknown>) {
    if (typeof window === 'undefined') return;
    
    await this.ensureInitialized();
    await this.trackEvent({
      session_id: this.currentSessionId,
      event_type: 'feature_use',
      page_path: pagePath,
      event_data: {
        feature_name: featureName,
        ...additionalData,
      },
    });
  }

  async trackError(error: Error, pagePath?: string) {
    try {
      const errorData: AnalyticsError = {
        session_id: this.currentSessionId,
        error_type: error.name || 'Unknown Error',
        error_message: error.message,
        stack_trace: error.stack,
        page_path: pagePath || (typeof window !== 'undefined' ? window.location.pathname : ''),
        user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',
      };

      const { data: userData } = await supabase.auth.getUser();
      if (userData.user) {
        errorData.user_id = userData.user.id;
        errorData.user_permission = (userData.user.user_metadata?.permission as string) || 
          ((userData.user as { raw_user_meta_data?: { permission?: string } }).raw_user_meta_data?.permission) || 'unknown';
      }

      const { error: dbError } = await analyticsSupabase
        .from('analytics_errors')
        .insert([errorData]);

      if (dbError) {
        console.error('Failed to track error:', dbError);
      }
    } catch (trackingError) {
      console.error('Error tracking failed:', trackingError);
    }
  }

  private async trackEvent(event: AnalyticsEvent) {
    try {
      console.log('üéØ Starting event tracking for:', event.event_type);
      
      // Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™çÔºà„Ç®„É©„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇÁ∂öË°åÔºâ
      try {
        const { data: userData, error: authError } = await supabase.auth.getUser();
        
        if (authError) {
          console.warn('‚ö†Ô∏è Auth error during event tracking:', authError);
          // Ë™çË®º„Ç®„É©„Éº„Åß„ÇÇ„Ç§„Éô„É≥„ÉàËøΩË∑°„ÅØÁ∂öË°å
          event.user_permission = 'unauthenticated';
        } else if (userData.user) {
          event.user_id = userData.user.id;
          const permission = 
            userData.user.user_metadata?.permission ||
            (userData.user as { raw_user_meta_data?: { permission?: string } }).raw_user_meta_data?.permission ||
            'unknown';
          event.user_permission = permission as string;
          
          console.log('üë§ User data for event:', {
            userId: userData.user.id,
            permission,
            email: userData.user.email
          });
        } else {
          console.log('üë§ Anonymous event tracking');
          event.user_permission = 'anonymous';
        }
      } catch (authException) {
        console.warn('‚ö†Ô∏è Auth exception during event tracking:', authException);
        event.user_permission = 'auth_failed';
      }
      
      // „Ç§„Éô„É≥„Éà„Éá„Éº„Çø„ÅÆÊúÄÁµÇÊ§úË®º
      const finalEvent = {
        session_id: event.session_id,
        user_id: event.user_id || null,
        user_permission: event.user_permission || 'unknown',
        event_type: event.event_type,
        page_path: event.page_path || null,
        element_id: event.element_id || null,
        element_type: event.element_type || null,
        event_data: event.event_data || null,
      };
      
      console.log('üìä Final event data to insert:', finalEvent);
      
      // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÊåøÂÖ•ÔºàRLSÂõûÈÅø„ÅÆ„Åü„ÇÅÂ∞ÇÁî®„ÇØ„É©„Ç§„Ç¢„É≥„Éà‰ΩøÁî®Ôºâ
      const { data: result, error } = await analyticsSupabase
        .from('analytics_events')
        .insert([finalEvent])
        .select('id');

      if (error) {
        console.error('‚ùå Event tracking failed:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code,
          eventType: event.event_type,
          fullError: error,
          attemptedData: finalEvent
        });
        
        // ÂÖ∑‰ΩìÁöÑ„Å™„Ç®„É©„ÉºÂàÜÊûê
        if (error.code === 'PGRST116') {
          console.error('üîß Analytics events table not found. Please run analytics-setup.sql');
        } else if (error.code === '23505') {
          console.error('üîß Duplicate key constraint violation');
        } else if (error.code === '23502') {
          console.error('üîß Not null constraint violation. Missing required field.');
        } else if (error.code === '42703') {
          console.error('üîß Column does not exist in table');
        } else if (error.message?.includes('permission')) {
          console.error('üîß RLS policy blocking insert. Check table policies.');
        }
        
        // „Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        console.log('üîç Checking database state...');
        const { error: tableError } = await supabase
          .from('analytics_events')
          .select('count')
          .limit(0);
          
        if (tableError) {
          console.error('üîß Table access error:', tableError);
        } else {
          console.log('‚úÖ Table accessible');
        }
        
      } else {
        console.log('‚úÖ Event tracked successfully:', {
          eventType: event.event_type,
          insertedId: result?.[0]?.id
        });
      }
    } catch (error) {
      console.error('üí• Event tracking critical error:', {
        error,
        type: typeof error,
        message: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : undefined
      });
    }
  }

  private async updateSessionPageViews() {
    try {
      const { error } = await analyticsSupabase
        .from('analytics_sessions')
        .update({ page_views: this.pageViews })
        .eq('session_id', this.currentSessionId);

      if (error) {
        console.error('Failed to update session page views:', error);
      }
    } catch (error) {
      console.error('Session update error:', error);
    }
  }

  async endSession() {
    try {
      const endTime = new Date();
      const duration = Math.floor((endTime.getTime() - this.sessionStartTime.getTime()) / 1000);

      const { error } = await analyticsSupabase
        .from('analytics_sessions')
        .update({
          end_time: endTime.toISOString(),
          duration_seconds: duration,
          page_views: this.pageViews,
        })
        .eq('session_id', this.currentSessionId);

      if (error) {
        console.error('Failed to end session:', error);
      }
    } catch (error) {
      console.error('Session end error:', error);
    }
  }

  // ÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁî®„ÅÆ„Éá„Éº„ÇøÂèñÂæó„É°„ÇΩ„ÉÉ„Éâ
  async getAnalyticsSummary() {
    try {
      const [sessionsRes, eventsRes, errorsRes] = await Promise.all([
        supabase
          .from('analytics_sessions')
          .select('*')
          .order('start_time', { ascending: false }),
        supabase
          .from('analytics_events')
          .select('*')
          .order('timestamp', { ascending: false }),
        supabase
          .from('analytics_errors')
          .select('*')
          .order('timestamp', { ascending: false }),
      ]);

      return {
        sessions: sessionsRes.data || [],
        events: eventsRes.data || [],
        errors: errorsRes.data || [],
      };
    } catch (error) {
      console.error('Failed to fetch analytics summary:', error);
      return { sessions: [], events: [], errors: [] };
    }
  }
}

export const analyticsService = new AnalyticsService();